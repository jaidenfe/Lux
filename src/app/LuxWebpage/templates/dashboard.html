<!DOCTYPE html>
<html lang="en">
  <head>
	<title> Lux: Wireless Home Illumination </title>
	<link rel = "shortcut icon" href = "{{url_for('static', filename = 'images/Lightbulb.ico') }}">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="{{url_for('static', filename = 'vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{url_for('static', filename = 'css/style.css') }}" rel="stylesheet">
	<link href="{{url_for('static', filename = 'vendor/bootstrap/css/bootstrap.css') }}" rel="stylesheet">
    <link rel="stylesheet" href="{{url_for('static',filename = 'vendor/font-awesome/css/font-awesome.min.css') }}">
    <link rel="stylesheet" href="{{url_for('static',filename = 'vendor/simple-line-icons/css/simple-line-icons.css') }}">
	<link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Catamaran:100,200,300,400,500,600,700,800,900" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
  </head>

  <body onload = "loading_page()">

    <nav class="navbar navbar-expand-md navbar-dark bg-dark fixed-top">
      <a class="navbar-brand" href="/">LUX</a>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarsExampleDefault" aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
          <!-- <li class="nav-item active">
            <a class="nav-link" href="index.html">Home <span class="sr-only">(current)</span></a>
          </li> -->
          <li class="nav-item">
            <a class="nav-link" href="Luxabout.html">About</a>
          </li>
          <li class = "nav-item" style = "float:right">
			<a class = "nav-link" href = "Luxcontact.html"> Contact </a>
          </li>
		  <li class = "nav-item" style = "float:right">
			<a class = "nav-link" href = "dashboard.html"> Dashboard </a>
          </li>
        </ul>
      </div>
    </nav>

    <div class="container">

		<div id = "invalid_alert">

		</div>

		<div class="starter-template">
			<br> <br> <br>
			<br>
			<h1 class = "text-center" style = "background-color:#555;color:white;margin-bottom:0px;border-radius:5px;">Lux dashboard - Devices</h1>
			<div id = 'user_devices'>

			</div>

		<!-- <button class = "btn" onclick = "addDevice"> Add new device </button> -->
		</div>
		<hr>

		  <footer>
			<p>CSE 442 - Fall 2017&copy; </p>
		  </footer>
    </div><!-- /.container -->
	<script>
    setInterval("loading_page()", 5000);
		var request_for_page = {"cmd": "2"};

		var deviceState = {};
		function loading_page() {
			sendRequest(true, request_for_page, "/status_req");
		}

		function sendRequest(upd, data, type) {
			var xhttp = new XMLHttpRequest();
			xhttp.open("POST", type, true);
			xhttp.setRequestHeader("Content-type", "application/json");
			xhttp.onreadystatechange = function() {
				if (this.readyState == 4 && this.status == 200) {
					if (upd) {
						onPageLoad(this);
					}
          else{
            var resp = xhttp.responseText;
            myDevices = JSON.parse(resp);
            var devicePictureState = checkOnOrOffState(myDevices.data.level);
            deviceState[myDevices.serial] = myDevices.data.level;
            // alert(myDevices.serial);
            document.getElementById(myDevices.serial).getElementsByClassName("Device_img")[0].src=devicePictureState.src;

            // alert(devicePictureState);

          }
				}
			}
			var param = JSON.stringify(data);
			xhttp.send(param);
		}

		function onPageLoad(xhttp) {
			var resp = xhttp.responseText;
			myDevices = JSON.parse(resp);
		  // alert(resp);
      var devices = document.getElementById("user_devices");
      while(devices.hasChildNodes()){
        devices.removeChild(devices.lastChild);
      }
			var mylist = document.createElement("ul");
			mylist.id = "myLuxDevices";
			mylist.className = "list-group";
			for (x in myDevices) {

				var deviceID = myDevices[x].serial;
				//var deviceName = myDevices[x].data.name;
				deviceState[deviceID]=myDevices[x].data.level;
				var device_img = checkOnOrOffState(deviceState[deviceID]);
				var device = document.createElement("li");
				var deviceInfo = document.createElement("div");
				var deviceName = document.createElement("h2");
				var deviceSerial = document.createElement("h4");
				var sliderCon = document.createElement("div");
				var stateSlider = document.createElement('label');
				var checkBox = document.createElement('input');
				var handler = document.createElement('span');
				var setting = document.createElement('i');
				setting.className ="icon-settings text-primary";

				sliderCon.className = "slider-con my-auto ";
				deviceInfo.className = "my-auto deviceName";
				deviceName.className = "";
				deviceSerial.className = "text-muted text-center"
				checkBox.type = "checkbox";
				checkBox.className = "";
				handler.innerHTML="ON OFF";
				handler.className = "slider round";

				stateSlider.className = "switch";

				deviceInfo.appendChild(deviceName);

				deviceInfo.appendChild(deviceSerial);
				stateSlider.appendChild(checkBox);
				stateSlider.appendChild(handler);
				sliderCon.appendChild(stateSlider);
				if(myDevices[x].data.level==10){
					checkBox.checked=true;
				}else{
					checkBox.checked = false;
				}
				deviceName.innerHTML= "Device Name: "+myDevices[x].data.name;
				deviceSerial.innerHTML = "- Serial number: "+ myDevices[x].serial+ " -";
				deviceName.style.textAlign ="center";
				device.className = "list-group-item device";
				device.style.display = "flex";
				device.id = deviceID;
				device.appendChild(deviceInfo);
				device.appendChild(sliderCon);
				device.appendChild(device_img);
				device.appendChild(setting);

				stateSlider.addEventListener("click",onState(myDevices[x].data.name,deviceID));
				mylist.appendChild(device);
			}

			document.getElementById("user_devices").appendChild(mylist);

			//var count = 0;
      //document.addEventListener('click',onState(myDevices[temp[0]].Device,myDevices[temp[0]].serial));
		}

		function checkOnOrOffState(deviceState) {
			if (deviceState == 10) {
				var image = document.createElement('img');
				image.src = "{{url_for('static', filename = 'images/lighton.jpg') }}";
				image.className = "Device_img";
				return image;
			}
			else if (deviceState == 0) {
				var image = document.createElement('img');
				image.src = "{{url_for('static', filename = 'images/lightoff.jpg') }}";
				image.className = "Device_img";
				return image;
			}
		}
		function onState(deviceName, deviceID) {
			return function(){
				if(deviceState[deviceID]==0){
						var data = {"cmd":"4", "uuid":"0", "serial": deviceID, "data":{"name": deviceName, "level": 10}};
						// alert("ON");
						//deviceState[deviceID]=10;

						sendRequest(false, data, "/update_req");
				}
				else if (deviceState[deviceID]==10){
				  var data = {"cmd":"4", "uuid":"0", "serial": deviceID, "data":{"name": deviceName, "level": 0}};
						// alert("OFF");
						//deviceState[deviceID]=0;
				  sendRequest(false, data, "/update_req");
				}
			}
		}

		</script>



    <!-- Bootstrap core JavaScript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
	<script src="{{url_for('static',filename = 'vendor/jquery/jquery.min.js') }}"></script>
	<script src="{{url_for('static',filename = 'vendor/popper/popper.min.js') }}"></script>
	<script src="{{url_for('static',filename = 'vendor/bootstrap/js/bootstrap.js') }}"></script>
    <script src="{{url_for('static',filename = 'vendor/bootstrap/js/bootstrap.min.js') }}"></script>
	<script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
  </body>
</html>
